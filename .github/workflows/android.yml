name: Build Android APK

# ì–¸ì œ ì´ ë¹Œë“œ ì‘ì—…ì„ ì‹¤í–‰í•  ê²ƒì¸ê°€?
on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # [ìƒˆë¡œ ì¶”ê°€ë¨] Gluonì´ ìš”êµ¬í•˜ëŠ” Maven 3.8.8 ë²„ì „ìœ¼ë¡œ ê°•ì œ ë‹¤ìš´ë¡œë“œ ë° ì„¤ì •
      - name: Setup Maven 3.8.8
        run: |
          wget https://archive.apache.org/dist/maven/maven-3/3.8.8/binaries/apache-maven-3.8.8-bin.tar.gz
          tar xzf apache-maven-3.8.8-bin.tar.gz
          echo "${PWD}/apache-maven-3.8.8/bin" >> $GITHUB_PATH

      - name: Setup GraalVM for Gluon
        uses: gluonhq/setup-graalvm@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 4. ì•ˆë“œë¡œì´ë“œ ë„¤ì´í‹°ë¸Œ ë¹Œë“œ ì‹œì‘ (âœ… ì´ë¯¸ ì™„ë²½í•˜ê²Œ ì„±ê³µí•˜ëŠ” ë¶€ë¶„!)
      - name: Build Native Android App
        run: mvn gluonfx:build

      # ğŸš¨ [ìƒˆë¡œ ì¶”ê°€ë¨] ì•ˆë“œë¡œì´ë“œ ì•± í¬ì¥ ë„êµ¬(Gradle)ë¥¼ ìœ„í•´ Javaë¥¼ 17ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.
      - name: Setup Java 17 for Packaging
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 5. ì™„ì„±ëœ ì•±ì„ APK íŒŒì¼ë¡œ íŒ¨í‚¤ì§•
      - name: Package into APK
        run: |
          unset ANDROID_SDK_ROOT
          mvn gluonfx:package

      # 6. íŒ¨í‚¤ì§• ì‹¤íŒ¨ ì‹œ ë¡œê·¸ ì¶œë ¥ (í˜¹ì‹œ ëª¨ë¥¼ ìƒí™© ëŒ€ë¹„)
      - name: Show Packaging Error Logs
        if: failure()
        run: |
          echo "=== ğŸš¨ íŒ¨í‚¤ì§• ìƒì„¸ ì—ëŸ¬ ë¡œê·¸ ğŸš¨ ==="
          cat target/gluonfx/log/*.log
          cat target/gluonfx/aarch64-android/gvm/log/*.log || true

      # 7. ì™„ì„±ëœ APK ë‹¤ìš´ë¡œë“œ íŒŒì¼ ìƒì„±
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Ssul-Pull-eo-jo-APK
          path: target/client/aarch64-android/gvm/*.apk